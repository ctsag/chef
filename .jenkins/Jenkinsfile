pipeline {
  agent any

  environment {
    cookbookDir = 'cookbooks/nothingness'
    reportDir = 'reports'
  }

  stages {
    stage('Lint Tests') {
      parallel {
        stage('cookstyle') {
          steps {
            sh 'mkdir ${reportDir}'
            sh 'cookstyle -DES -f h ${cookbookDir} > ${reportDir}/cookstyle.html'
            publishHTML([
              allowMissing: false,
              alwaysLinkToLastBuild: false,
              keepAll: false,
              reportDir: 'reports',
              reportFiles: 'cookstyle.html',
              reportName: 'Cookstyle Report',
              reportTitles: ''
            ])
          }
        }
        stage('foodcritic') {
          steps {
            sh 'foodcritic ${cookbookDir}'
          }
        }
      }
    }
    stage('Unit Tests') {
      parallel {
        stage('rspec') {
          steps {
            dir(cookbookDir) {
              sh 'chef exec rspec -f d spec/unit/recipes/*'
            }
          }
        }
      }
    }    
  }

  post {
    always {
      dir(reportDir) {
        deleteDir()
      }
    }
  }
}
