pipeline {

  agent any

  environment {
    cookbookDir = 'cookbooks/nothingness'
    branchType = env.GIT_BRANCH.substring(0, 2)
  }

  stages {
    stage('Lint Tests') {
      parallel {
        stage('CookStyle') {
          steps {
            sh 'cookstyle -DES ${cookbookDir}'
          }
        }
        stage('Foodcritic') {
          steps {
            sh 'foodcritic ${cookbookDir}'
          }
        }
      }
    }
    stage('Unit Tests') {
      parallel {
        stage('RSpec') {
          steps {
            dir(cookbookDir) {
              sh 'chef exec rspec -f d spec/unit/recipes/*'
            }
          }
        }
      }
    }
    stage('Integration Tests') {
      when {
        allOf {
          environment name: 'branchType', value: 'PR';
          environment name: 'CHANGE_TARGET', value: 'master'
        }
      }
      parallel {
        stage('Kitchen CI') {
          steps {
            dir(cookbookDir) {
              sh 'kitchen verify dev'
            }
          }
        }
      }
    }
  }

  post {
    always {
      dir(cookbookDir) {
        sh 'kitchen destroy'
      }
    }
  }

}
